- name: "Run tests"
  type: parallel
  steps:
    - name: "Test node-ci"
      service: node-ci
      command: /goss/goss -g /tmp/goss.yaml v -f rspecish

    - name: "Test php-ci"
      service: php-ci
      command: /goss/goss -g /tmp/goss.yaml v -f rspecish

## Publish latest
- name: "Publish latest tags"
  type: parallel
  tag: master
  steps:
    - name: "Push ushahidi/php-ci:latest"
      service: php-ci
      type: push
      image_name: ushahidi/php-ci
      image_tag: latest
      registry: https://index.docker.io/v1/
      encrypted_dockercfg_path: dockercfg.encrypted

    - name: "Push ushahidi/node-ci:latest"
      service: node-ci
      type: push
      image_name: ushahidi/node-ci
      image_tag: latest
      registry: https://index.docker.io/v1/
      encrypted_dockercfg_path: dockercfg.encrypted

## Publish PHP release tags
- name: "Publish PHP release tags"
  type: parallel
  tag: '^php-.*'
  steps:
    - name: "Push ushahidi/php-ci:(php release tag)"
      service: php-ci
      type: push
      image_name: ushahidi/php-ci
      image_tag: "{{.Branch}}"
      registry: https://index.docker.io/v1/
      encrypted_dockercfg_path: dockercfg.encrypted

## Publish node release tags
- name: "Publish Node release tags"
  type: parallel
  tag: '^node-.*'
  steps:
    - name: "Push ushahidi/node-ci:(node release tag)"
      service: node-ci
      type: push
      image_name: ushahidi/node-ci
      image_tag: "{{.Branch}}"
      registry: https://index.docker.io/v1/
      encrypted_dockercfg_path: dockercfg.encrypted
